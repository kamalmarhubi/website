<meta charset="utf-8">
<title>hg advent -m '05: heads and `hg commit --close`'</title>
<style>
body {
    max-width: 960px
}
</style>
<h1>hg advent -m '05: heads and `hg commit --close`'</h1>
<p>I found out how a couple of key parts of unnamed branches works: changesets can be marked as closed, and mercurial can keep track of the leaf changesets that aren’t closed. This answers the big question I had of how you can possibly make this work without getting lost in a sea of work.</p>
<p>This is pretty cool! It means that when a string of commits are done with, eg because you’ve decided it’s not a useful direction, you can tell mercurial. And at any point, you can ask mercurial to see what open work exists.</p>
<h2 id="an-example">An example</h2>
<p>This is contrived. I’m going to start off with the default Rust skeleton you get from <code>cargo new</code>, and translate it into a few languages.</p>
<pre><code>$ cargo new --vcs=hg hw
     Created binary (application) `hw` project
$ cd hw
$ cargo --quiet run
Hello, world!
$ hg add .
$ hg commit -m&#39;Add cargo skeleton&#39;</code></pre>
<p>Ok so now we have saved the initial state: hello world in English. Now let’s start on a translation into Spanish:</p>
<pre><code>$ sed -i &#39;s/Hello/Hola/&#39; src/main.rs
$ cargo --quiet run
Hola, world!
$ hg commit -m&#39;Translate hello into spanish&#39;</code></pre>
<p>Off to a great start! Let’s take a look</p>
<pre><code>$ hg log --graph --template=compact
@  1[tip]   4ca430c10413   2018-12-06 20:56 -0500   kamal
|    Translate hello into spanish
|
o  0   0345dfb2199e   2018-12-06 20:53 -0500   kamal
     Add cargo skeleton</code></pre>
<p>I’m not sure if world is “mondo” or “mundo” at this point, so I’ll switch to translating German. First, let’s go back to the skeleton with <code>hg checkout</code><a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a></p>
<pre><code>$ hg checkout 0
1 files updated, 0 files merged, 0 files removed, 0 files unresolved
$ sed -i &#39;s/world/welt/&#39; src/main.rs
$ cargo --quiet run
Hello, welt!
$ hg commit -m&#39;Translate world into german&#39;
created new head</code></pre>
<h2 id="created-new-head">Created new head?</h2>
<p>Mercurial just told us we created a new head. This means there is a new lineage, which we can see in the log:</p>
<pre><code>$ hg log --graph --template=compact
@  2[tip]:0   472ad1d630ef   2018-12-06 21:04 -0500   kamal
|    Translate world into german
|
| o  1   4ca430c10413   2018-12-06 20:56 -0500   kamal
|/     Translate hello into spanish
|
o  0   0345dfb2199e   2018-12-06 20:53 -0500   kamal
     Add cargo skeleton</code></pre>
<p>Because mercurial is aware of the heads, we can list the heads with <code>hg heads</code>:</p>
<pre><code>$ hg heads
changeset:   2:472ad1d630ef
tag:         tip
parent:      0:0345dfb2199e
user:        Kamal Marhubi &lt;kamal@marhubi.com&gt;
date:        Thu Dec 06 21:04:19 2018 -0500
summary:     Translate world into german

changeset:   1:4ca430c10413
user:        Kamal Marhubi &lt;kamal@marhubi.com&gt;
date:        Thu Dec 06 20:56:46 2018 -0500
summary:     Translate hello into spanish</code></pre>
<p>Let’s throw one more language into the mix, before demonstrating how we can tell mercurial we’re no long interested in one of these lines of work.</p>
<pre><code>$ hg checkout 0
1 files updated, 0 files merged, 0 files removed, 0 files unresolved
$ sed -i &#39;s/Hello, world/Salamu, dunia/&#39; src/main.rs
$ cargo --quiet run
Salamu, dunia!
$ hg commit -m&#39;Translate the whole thing into swahili&#39;
created new head</code></pre>
<p>Now let’s check the graph and the list of heads:</p>
<pre><code>$ hg log --graph --template=compact
@  3[tip]:0   b14c88540219   2018-12-06 21:18 -0500   kamal
|    Translate the whole thing into swahili
|
| o  2:0   472ad1d630ef   2018-12-06 21:04 -0500   kamal
|/     Translate world into german
|
| o  1   4ca430c10413   2018-12-06 20:56 -0500   kamal
|/     Translate hello into spanish
|
o  0   0345dfb2199e   2018-12-06 20:53 -0500   kamal
     Add cargo skeleton

$ hg heads
changeset:   3:b14c88540219
tag:         tip
parent:      0:0345dfb2199e
user:        Kamal Marhubi &lt;kamal@marhubi.com&gt;
date:        Thu Dec 06 21:18:02 2018 -0500
summary:     Translate the whole thing into swahili

changeset:   2:472ad1d630ef
parent:      0:0345dfb2199e
user:        Kamal Marhubi &lt;kamal@marhubi.com&gt;
date:        Thu Dec 06 21:04:19 2018 -0500
summary:     Translate world into german

changeset:   1:4ca430c10413
user:        Kamal Marhubi &lt;kamal@marhubi.com&gt;
date:        Thu Dec 06 20:56:46 2018 -0500
summary:     Translate hello into spanish</code></pre>
<p>Makes sense.</p>
<h2 id="closing-a-head">Closing a head</h2>
<p>Now it’s late and my sister, who’s fluent in spanish, can’t tell me if it’s “mondo” or “mundo” tonight. So I’m going to close that branch out to have less work in progress floating around.</p>
<pre><code>$ hg checkout 1
1 files updated, 0 files merged, 0 files removed, 0 files unresolved
$ hg commit --close -m&#39;Close branch: could not get translation of world&#39;</code></pre>
<p>Now if we list the heads, that one won’t be shown:</p>
<pre><code>$ hg heads
changeset:   3:b14c88540219
parent:      0:0345dfb2199e
user:        Kamal Marhubi &lt;kamal@marhubi.com&gt;
date:        Thu Dec 06 21:18:02 2018 -0500
summary:     Translate the whole thing into swahili

changeset:   2:472ad1d630ef
parent:      0:0345dfb2199e
user:        Kamal Marhubi &lt;kamal@marhubi.com&gt;
date:        Thu Dec 06 21:04:19 2018 -0500
summary:     Translate world into german</code></pre>
<p>It’s still there, and shows up in the graph:</p>
<pre><code>$ hg log --graph --template=compact
@  4[tip]:1   80da88bcc1a8   2018-12-06 21:21 -0500   kamal
|    Close branch: could not get translation of world
|
| o  3:0   b14c88540219   2018-12-06 21:18 -0500   kamal
| |    Translate the whole thing into swahili
| |
| | o  2:0   472ad1d630ef   2018-12-06 21:04 -0500   kamal
| |/     Translate world into german
| |
o |  1   4ca430c10413   2018-12-06 20:56 -0500   kamal
|/     Translate hello into spanish
|
o  0   0345dfb2199e   2018-12-06 20:53 -0500   kamal
     Add cargo skeleton</code></pre>
<p>Actually if we switch away from the closed head, we can see that it gets a different marker in the graph:</p>
<pre><code>$ hg checkout null
0 files updated, 0 files merged, 4 files removed, 0 files unresolved
$ hg log --graph --template=compact
_  4[tip]:1   80da88bcc1a8   2018-12-06 21:21 -0500   kamal
|    Close branch: could not get translation of world
|
| o  3:0   b14c88540219   2018-12-06 21:18 -0500   kamal
| |    Translate the whole thing into swahili
| |
| | o  2:0   472ad1d630ef   2018-12-06 21:04 -0500   kamal
| |/     Translate world into german
| |
o |  1   4ca430c10413   2018-12-06 20:56 -0500   kamal
|/     Translate hello into spanish
|
o  0   0345dfb2199e   2018-12-06 20:53 -0500   kamal
     Add cargo skeleton</code></pre>
<p>Instead of a letter <code>o</code>, it gets an underscore. And if we wanted to exclude it, we can use our <a href="hg-revsets">newfound revset knowledge</a>:</p>
<pre><code>$ hg log --graph --template=compact -r &#39;not closed()&#39;
o  3:0   b14c88540219   2018-12-06 21:18 -0500   kamal
|    Translate the whole thing into swahili
|
| o  2:0   472ad1d630ef   2018-12-06 21:04 -0500   kamal
|/     Translate world into german
|
| o  1   4ca430c10413   2018-12-06 20:56 -0500   kamal
|/     Translate hello into spanish
|
o  0   0345dfb2199e   2018-12-06 20:53 -0500   kamal
     Add cargo skeleton</code></pre>
<p>And if we wanted it in the list of heads, we can ask mercurial to include
closed ones</p>
<pre><code>$ hg heads --closed
changeset:   4:80da88bcc1a8
tag:         tip
parent:      1:4ca430c10413
user:        Kamal Marhubi &lt;kamal@marhubi.com&gt;
date:        Thu Dec 06 21:21:16 2018 -0500
summary:     Close branch: could not get translation of world

changeset:   3:b14c88540219
parent:      0:0345dfb2199e
user:        Kamal Marhubi &lt;kamal@marhubi.com&gt;
date:        Thu Dec 06 21:18:02 2018 -0500
summary:     Translate the whole thing into swahili

changeset:   2:472ad1d630ef
parent:      0:0345dfb2199e
user:        Kamal Marhubi &lt;kamal@marhubi.com&gt;
date:        Thu Dec 06 21:04:19 2018 -0500
summary:     Translate world into german</code></pre>
<h2 id="its-starting-to-make-sense">It’s starting to make sense</h2>
<p>Unnamed branches have been the part of mercurial that have me most intrigued. They’re really close to my current workflow in git, but I wasn’t sure how it could work. Now that I’ve seen <code>hg heads</code> and <code>hg commit --close</code> I can actually imagine how it’d work. I’m still a ways away from knowing if it’ll work for me, fingers crossed!</p>
<section class="footnotes">
<hr />
<ol>
<li id="fn1"><p><code>hg checkout</code> is a built-in alias for <code>hg update</code>, which updates the working directory or switces revisions. It’s equivalent to one of the several meanings of <code>git checkout</code>, in this case, the <code>git checkout &lt;commit-ish&gt;</code> variant. I’m not sure I like the use of the word <code>update</code> here, hence my using the alias.<a href="#fnref1" class="footnote-back">↩</a></p></li>
</ol>
</section>

